<!DOCTYPE html>
<html>
  <head>
    <title>Device Properties Example</title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"></script>
    <!---  VALOR APIKEY: AIzaSyCTj2UDMMYLM28CcqpQBGmycxMeUslXbRE --> 
    <!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTj2UDMMYLM28CcqpQBGmycxMeUslXbRE"></script>
    <script src="https://rawgit.com/HPNeo/gmaps/master/gmaps.js"></script>-->
  </head>
  <body style="position: relative; margin:0 auto; text-align: center; width: 100%; background-color:#B0A88B; ">
    <div id="cabecera">
        <div style="float: left; position: absolute; margin: 0 auto; margin-left:2em;" id="flechaBack"><img src="home.png" onclick="atras();"></div>
        <h1 id="tituloCabeceraPrincipal" style="color:#36c; letter-spacing: 0.15em;" >PRL</h1>
    </div>
    <div id="cuerpo">
        <p id="fichero"></p>
        <!--Pinta mapa:-->
        <div id="basic_map"></div>
        <!--Pinta botones eleccion tipo navegacion:-->
        <div id="onlineOffline">
            <input id="ofWork" type="button" name="Trabajar Offline" value="Trabajar Offline" onclick="modoNav('1');" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase; margin-bottom:1em;"><br/>
            <input id="onWork"  type="button" name="Trabajar Online" value="Trabajar Online" onclick="modoNav('2');" style=" position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--OFFLINE-->
        <div id="modoOffline" style="display:none;">
            <input id="revOffline" type="button" name="Nueva Revisi&oacute;n" value="Nueva Revisi&oacute;n" onclick="abreNuevoForm();" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; margin-bottom: 4em; overflow: hidden; text-decoration: none; text-transform: uppercase;"><br/>
            <span>OBRA EJEMPLO 1 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 2 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 3 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 4 . CERRADA</span><br/>
        </div>        
        <div id="nuevoNombreForm" style="display:none;">
            <input type="text" value="" placeholder="Nombre Obra" id="obraName" style="margin: 0 auto;text-align: center; border-radius: 4px; border: 0; font-size: 1.5em;  overflow: hidden; text-decoration: none; margin-bottom:1em;"><br/>
            <input id="nuevRevOff" type="button" value="Crear Nueva Revision" name="Crear Nueva Revision" onclick="guardaFormTmp();" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--ONLINE-->
        <div id="modoOnline" style="display:none;">
            <select id="seleccionObra" style="margin: 0 auto;text-align: center; border-radius: 4px; border: 0; font-size: 1.5em;  overflow: hidden; text-decoration: none; margin-bottom:1em; font-size:12pt;">
                <option value="0" selected>Seleccione una obra</option>
                <option value="1">Obra 1</option>
                <option value="2">Obra 2</option>
                <option value="3">Obra 3</option>
                <option value="4">Obra 4</option>
            </select><br/>
            <input id="revOnln" type="button" name="Nueva Revisi&oacute;n" value="Nueva Revisi&oacute;n" onclick="abreNuevoForm();" style="margin-top:1em; position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--Pinta Formulario a partir del xml:-->
        <div id="formularioXML" style="display:none;" ></div>
    </div>

    <div id="pie"></div>
    <!--Valores necesarios ocultos:-->    
    <input type="hidden" id="onlOffl" value="">
    <input type="hidden" id="zonaSel" value=""> 
    <input type="hidden" id="carpetaTmpName" value="">
    <input type="hidden" id="nombrOculto" value=""> 
  </body>
</html>

<!--Funciones necesarias:-->
<script>

document.addEventListener("deviceready", onDeviceReady, false);


function populateDB(tx) {
    tx.executeSql('CREATE TABLE IF NOT EXISTS formulario (id unique, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto)');
    tx.executeSql("INSERT INTO formulario (id, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto) VALUES (1, '1.1', 'Se dispone en la obra de Plan de Seguridad y Salud / Plan de Medidas Preventivas de los trabajos', 'SI/NO' , 'Documentación' , '2.1', '2.1', '', '', '1')");
    tx.executeSql("INSERT INTO formulario (id, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto) VALUES (2, '2.1', 'El espacio de trabajo está limpio y ordenado', 'SI/NO/NP' , 'Lugar de trabajo/Orden y limpieza' , '2.2', '2.2', '2.2', 'NO/foto_obligatoria', '1')");
    tx.executeSql("INSERT INTO formulario (id, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto) VALUES (3, '2.2', 'Estan delimitadas las zonas de trabajo de las zonas de transito', 'SI/NO/NP' , 'Orden y limpieza' , '2.3', '2.3', '2.3', 'NO/foto_obligatoria', '1')");
    tx.executeSql("INSERT INTO formulario (id, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto) VALUES (4, '2.3', 'Los acopios de  material tienen zona reservada, el material se apila de forma estable y en zona firme, dejando libre la zona de circulación de vehiculos y/o zona de paso de peatones', 'SI/NO/NP' , 'Orden y limpieza' , '2.4', '2.4', '2.4', 'NO/foto_obligatoria', '1')");

}

function querySuccess(tx, results) {
    var len = results.rows.length;
    alert("formulario table: " + len + " rows found.");
    for (var i=0; i<len; i++){
        alert("Row = " + i + " ID = " + results.rows.item(i).id + 
            " id_pregunta =  " + results.rows.item(i).id_pregunta + 
            " pregunta =  " + results.rows.item(i).pregunta + 
            " respuestas =  " + results.rows.item(i).respuestas + 
            " categoria =  " + results.rows.item(i).categoria + 
            " si_continua =  " + results.rows.item(i).si_continua + 
            " no_continua =  " + results.rows.item(i).no_continua + 
            " np_continua =  " + results.rows.item(i).np_continua + 
            " accion =  " + results.rows.item(i).accion + 
            " proyecto =  " + results.rows.item(i).proyecto);
    }
}

function errorCB(err) {
    if(err.code==6){
        alert('ya existe la DB');
        successCB();
    }else{
        alert("Error processing SQL: "+err.message);
    }
}

function successCB() {
    var db = window.openDatabase("prlDB", "1.0", "Base de datos PRL", 10000000);
    db.transaction(queryDB, errorCB);
}
 
function queryDB(tx) {
        tx.executeSql('SELECT * FROM formulario', [], querySuccess, errorCB);
    }

function onSuccess(position) {
    alert('succes de onSuccess:'+position)
    //var element = document.getElementById('geolocation');
    /*element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
                        'Longitude: '          + position.coords.longitude             + '<br />' +
                        'Altitude: '           + position.coords.altitude              + '<br />' +
                        'Accuracy: '           + position.coords.accuracy              + '<br />' +
                        'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
                        'Heading: '            + position.coords.heading               + '<br />' +
                        'Speed: '              + position.coords.speed                 + '<br />' +
                        'Timestamp: '          + position.timestamp                    + '<br />';

    /*var map = new GMaps({
            div: '#basic_map',
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            width: '500px',
            height: '500px',
            zoom: 12,
            zoomControl: true,
            
            zoomControlOpt: {
                style: 'SMALL',
                position: 'TOP_LEFT'
            },
            panControl: false
    });
    map.addMarker({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        title: 'Yo',
    });*/

}

function atras(){
    $('#tituloCabeceraPrincipal').html('PRL');
    $('#basic_map').css('display','block');   
    $('#onlineOffline').css('display','block'); 

    $('#modoOnline').css('display','none'); 
    $('#nuevoNombreForm').css('display','none'); 
    $('#modoOffline').css('display','none'); 
    $('#form').css('display','none'); 
}
function modoNav(zona){ 
    $('#seleccionObra').val('0');
    $('#obraName').val('');
    $('#onlineOffline').css('display','none'); 
    $('#basic_map').css('display','none');  
    if(zona==1){
        $('#tituloCabeceraPrincipal').html('PRL -- OFFLINE');
        $('#onlOffl').val('0');
        $('#modoOffline').css('display','block');    
        $('#modoOnline').css('display','none'); 
    }else{
        $('#tituloCabeceraPrincipal').html('PRL -- ONLINE');
        $('#onlOffl').val('1');
        $('#modoOnline').css('display','block');
        $('#modoOffline').css('display','none');
    }
}
function abreNuevoForm(){
    if($('#onlOffl').val()==0){
        //Offline
        $('#nuevoNombreForm').css('display','block');
        $('#modoOffline').css('display','none');
        $('#modoOnline').css('display','none'); 
        $('#onlineOffline').css('display','none');    
    }else{
        //Online
        if($('#seleccionObra').val()==0){
            alert('Debe seleccionar una obra');
        }else{
            $('obraNombre').val($('#seleccionObra').val()); 
            $('#form').css('display','block'); 
            $('#obraName').val($('#seleccionObra').val());
            window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onRequestFileSystemSuccess, null);
            $('#modoOnline').css('display','none'); 
            $('#onlineOffline').css('display','none');    
        }
    }
}
function guardaFormTmp(){
    alert($('#obraName').val());
    if($('#obraName').val()=="Crear Nueva Revision"){
        alert('Debe darle un nombre a la nueva revision');
    }else{
        $('#modoOnline').css('display','none'); 
        $('#onlineOffline').css('display','none'); 
        $('#nuevoNombreForm').css('display','none'); 
        $('#form').css('display','block');  
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onRequestFileSystemSuccess, null);     
        //Mostramos el form con el nombre:
        $('#nombreFormularioTmp').html('');
        $('#nombreFormularioTmp').html('FORMULARIO: '+nombreObra);
        $('#form').css('display','block'); 
    }   
}

/************CAMARA DE FOTOS**********/
function abreCamaraFoto() {
    navigator.camera.getPicture(onPhotoURISuccess, fsFail, { quality: 50, destinationType: Camera.DestinationType.FILE_URI });
}
function onPhotoURISuccess(imageURI) {
    alert('imageURI->'+imageURI);
    /*var carpetaDest = $('#carpetaTmpName').val();
    alert('carpetaDest->'+carpetaDest);
    imageURI.moveTo(carpetaDest, 'img000123.jpg', todoOK, fsFail);*/
}
function fsFail(error) {
    alert('failed with error code: ' + error.code);
}


function onDeviceReady() {
    alert('dvRdy');
    var db = window.openDatabase("prlDB", "1.0", "Base de datos PRL", 10000000);
    db.transaction(populateDB, errorCB, successCB);
}
</script>
