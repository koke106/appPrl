<!DOCTYPE html>
<html>
  <head>
    <title>Device Properties Example</title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"></script>
    <!---  VALOR APIKEY: AIzaSyCTj2UDMMYLM28CcqpQBGmycxMeUslXbRE --> 
    <!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTj2UDMMYLM28CcqpQBGmycxMeUslXbRE"></script>
    <script src="https://rawgit.com/HPNeo/gmaps/master/gmaps.js"></script>-->
  
<script type="text/javascript">
    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {

        //Comprobamos que tenemos al menos un xml disponible:
        alert('entro 1');
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onRequestFileSystemSuccess, null);
        /*alert('entro 2++');
        var entry=fileSystem.root; */
        
        //window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);

        //navigator.geolocation.getCurrentPosition(onSuccess, onError);
    }
    function onFileSystemSuccess(fileSystem) {
        alert('onFileSystemSuccess'+fileSystem.name);
    }

    function onResolveSuccess(fileEntry) {
        alert('onResolveSuccess'+fileEntry.name);
    }

    function fail(evt) {
        alert('fail'+evt.target.error.code);
    }

    function onSuccess(position) {
        var element = document.getElementById('geolocation');
        /*element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
                            'Longitude: '          + position.coords.longitude             + '<br />' +
                            'Altitude: '           + position.coords.altitude              + '<br />' +
                            'Accuracy: '           + position.coords.accuracy              + '<br />' +
                            'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
                            'Heading: '            + position.coords.heading               + '<br />' +
                            'Speed: '              + position.coords.speed                 + '<br />' +
                            'Timestamp: '          + position.timestamp                    + '<br />';

        /*var map = new GMaps({
                div: '#basic_map',
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                width: '500px',
                height: '500px',
                zoom: 12,
                zoomControl: true,
                
                zoomControlOpt: {
                    style: 'SMALL',
                    position: 'TOP_LEFT'
                },
                panControl: false
        });
        map.addMarker({
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            title: 'Yo',
        });*/

    }
    function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }

    </script>
  </head>
  <body style="position: relative; margin:0 auto; text-align: center; width: 100%; background-color:#B0A88B; ">
    <div id="cabecera">
        <div style="float: left; position: absolute; margin: 0 auto; margin-left:2em;" id="flechaBack"><img src="home.png" onclick="atras();"></div>
        <h1 id="tituloCabeceraPrincipal" style="color:#36c; letter-spacing: 0.15em;" >PRL</h1>
    </div>
    <div id="cuerpo">
        <p id="fichero"></p>
        <!--Pinta mapa:-->
        <div id="basic_map"></div>
        <!--Pinta botones eleccion tipo navegacion:-->
        <div id="onlineOffline">
            <input id="ofWork" type="button" name="Trabajar Offline" value="Trabajar Offline" onclick="modoNav('1');" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase; margin-bottom:1em;"><br/>
            <input id="onWork"  type="button" name="Trabajar Online" value="Trabajar Online" onclick="modoNav('2');" style=" position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--OFFLINE-->
        <div id="modoOffline" style="display:none;">
            <input id="revOffline" type="button" name="Nueva Revisi&oacute;n" value="Nueva Revisi&oacute;n" onclick="abreNuevoForm();" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; margin-bottom: 4em; overflow: hidden; text-decoration: none; text-transform: uppercase;"><br/>
            <span>OBRA EJEMPLO 1 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 2 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 3 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 4 . CERRADA</span><br/>
        </div>        
        <div id="nuevoNombreForm" style="display:none;">
            <input type="text" value="" placeholder="Nombre Obra" id="obraName" style="margin: 0 auto;text-align: center; border-radius: 4px; border: 0; font-size: 1.5em;  overflow: hidden; text-decoration: none; margin-bottom:1em;"><br/>
            <input id="nuevRevOff" type="button" value="Crear Nueva Revision" name="Crear Nueva Revision" onclick="guardaFormTmp();" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--ONLINE-->
        <div id="modoOnline" style="display:none;">
            <select id="seleccionObra" style="margin: 0 auto;text-align: center; border-radius: 4px; border: 0; font-size: 1.5em;  overflow: hidden; text-decoration: none; margin-bottom:1em; font-size:12pt;">
                <option value="0" selected>Seleccione una obra</option>
                <option value="1">Obra 1</option>
                <option value="2">Obra 2</option>
                <option value="3">Obra 3</option>
                <option value="4">Obra 4</option>
            </select><br/>
            <input id="revOnln" type="button" name="Nueva Revisi&oacute;n" value="Nueva Revisi&oacute;n" onclick="abreNuevoForm();" style="margin-top:1em; position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--Pinta Formulario a partir del xml:-->
        <div id="formularioXML" style="display:none;" ></div>
    </div>

    <div id="pie"></div>
    <!--Valores necesarios ocultos:-->    
    <input type="hidden" id="onlOffl" value="">
    <input type="hidden" id="zonaSel" value=""> 
    <input type="hidden" id="carpetaTmpName" value="">
    <input type="hidden" id="nombrOculto" value=""> 
  </body>
</html>

<!--Funciones necesarias:-->
<script>
function atras(){
    $('#tituloCabeceraPrincipal').html('PRL');
    $('#basic_map').css('display','block');   
    $('#onlineOffline').css('display','block'); 

    $('#modoOnline').css('display','none'); 
    $('#nuevoNombreForm').css('display','none'); 
    $('#modoOffline').css('display','none'); 
    $('#form').css('display','none'); 
}
function modoNav(zona){ 
    $('#seleccionObra').val('0');
    $('#obraName').val('');
    $('#onlineOffline').css('display','none'); 
    $('#basic_map').css('display','none');  
    if(zona==1){
        $('#tituloCabeceraPrincipal').html('PRL -- OFFLINE');
        $('#onlOffl').val('0');
        $('#modoOffline').css('display','block');    
        $('#modoOnline').css('display','none'); 
    }else{
        $('#tituloCabeceraPrincipal').html('PRL -- ONLINE');
        $('#onlOffl').val('1');
        $('#modoOnline').css('display','block');
        $('#modoOffline').css('display','none');
    }
}
function abreNuevoForm(){
    if($('#onlOffl').val()==0){
        //Offline
        $('#nuevoNombreForm').css('display','block');
        $('#modoOffline').css('display','none');
        $('#modoOnline').css('display','none'); 
        $('#onlineOffline').css('display','none');    
    }else{
        //Online
        if($('#seleccionObra').val()==0){
            alert('Debe seleccionar una obra');
        }else{
            $('obraNombre').val($('#seleccionObra').val()); 
            $('#form').css('display','block'); 
            $('#obraName').val($('#seleccionObra').val());
            window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onRequestFileSystemSuccess, null);
            $('#modoOnline').css('display','none'); 
            $('#onlineOffline').css('display','none');    
        }
    }
}

function guardaFormTmp(){
    alert($('#obraName').val());
    if($('#obraName').val()=="Crear Nueva Revision"){
        alert('Debe darle un nombre a la nueva revision');
    }else{
        $('#modoOnline').css('display','none'); 
        $('#onlineOffline').css('display','none'); 
        $('#nuevoNombreForm').css('display','none'); 
        $('#form').css('display','block');  
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onRequestFileSystemSuccess, null);     
        //Mostramos el form con el nombre:
        $('#nombreFormularioTmp').html('');
        $('#nombreFormularioTmp').html('FORMULARIO: '+nombreObra);
        $('#form').css('display','block'); 
    }   
}

/**********CREAR DIRECTORIO************/
function onRequestFileSystemSuccess(fileSystem) {   
    alert('entro request'+fileSystem);  
    var nombreObra = $('#obraName').val();
    nombreObra = nombreObra.replace(/\s/g,"_");
    nombreObra += '_0001';
    /*
    fileSystem.getDirectory("//prueba_0001/", {create: true, exclusive: false}, success, fail);

    alert('entro 2');
    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, onFileSystemSuccess, fail);
    alert('entro 3');
    window.resolveLocalFileSystemURI("file:///prueba.txt", onResolveSuccess, fail);
    alert('entro 4');
    window.resolveLocalFileSystemURI("file:///sdcard/prueba_0001/prueba.txt", onResolveSuccess, fail);
    alert('salgo de to');*/
    var entry=fileSystem.root;

    // copy the file to a new directory and rename it
    entry.copyTo(entry, "file.txt", onGetDirectorySuccess, onGetDirectoryFail);

} 
function onGetDirectorySuccess(dir) { 
    alert("Created dir "+dir.fullPath); 
    $('#carpetaTmpName').val(dir.fullPath);
    //Copiamos el formRespuestas.xml a esta nueva carpeta para empezar a rellenar:
    alert('llamammos al copye file con '+dir.fullPath);
    
    copyFile(dir.fullPath);

} 
/******* COPIAR XML DE RESPUESTAS A NUESTRA CARPETA TEMPORAL ******/

function correctaCopiaXml(entry) {
    alert("New Path: " + entry.fullPath);
}

function falloCopiaXml(error) {
    alert(error.code);
}

function copyFile(entry) {
    


    alert('viene con entry: '+entry);
    var ruta = $('#carpetaTmpName').val();
    alert('entro y pongo ruta: '+ruta);

    alert('entry: '+entry);
    // file:///android_asset/www/index.html
    // file:///android_asset/www/formulario_PRL.xml
    // copy the file to a new directory and rename it
}



function onGetDirectoryFail(error) { 
    alert("Error creating directory "+error.code); 
} 

/************CAMARA DE FOTOS**********/
function abreCamaraFoto() {
    navigator.camera.getPicture(onPhotoURISuccess, fsFail, { quality: 50, destinationType: Camera.DestinationType.FILE_URI });
}
function onPhotoURISuccess(imageURI) {
    alert('imageURI->'+imageURI);
    var carpetaDest = $('#carpetaTmpName').val();
    alert('carpetaDest->'+carpetaDest);
    imageURI.moveTo(carpetaDest, 'img000123.jpg', todoOK, fsFail);
}
function fsFail(error) {
    alert('failed with error code: ' + error.code);
}
function todoOK(resp){
    alert('resp->'+resp);
}


/**********TEST***************/
function gotFS(fileSystem) {
    fileSystem.root.getFile("formulario_PRL.xml", null, gotFileEntry, fail);
}

function gotFileEntry(fileEntry) {
    fileEntry.file(gotFile, fail);
}

function gotFile(file){
    readDataUrl(file);
    readAsText(file);
}

function readDataUrl(file) {
    var reader = new FileReader();
    reader.onloadend = function(evt) {
        alert("Read as data URL");
        alert(evt.target.result);
    };
    reader.readAsDataURL(file);
}

function readAsText(file) {
    var reader = new FileReader();
    reader.onloadend = function(evt) {
        alert("Read as text");
        alert(evt.target.result);
    };
    reader.readAsText(file);
}

function fail(error) {
    alert('error'+error.code);
}

function success(parent) {
    alert("Parent Name: " + parent.name);
}



$( document ).ready(function() {  
    

    //copyFile('formulario_PRL.xml');

    /*$.get("/formulario_PRL.xml", function (xml) {
        //Copiarlo a la ruta adecuada:
        ///sdcard/prueba_0001/
       
        $(xml).find("apartado").each(function () {

            //Aplicar a las diferentes secciones del XML:
     
           var seccion = $(this).find('seccion').text();
           var pregunta = $(this).find('pregunta').text();
           var etiqueta = $(this).find('etiqueta').text();
     
           alert('seccion->'+seccion+' pregunta->'+pregunta+' etiqueta->'+etiqueta);
        });
    });*/
});


</script>
