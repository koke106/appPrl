<!DOCTYPE html>
<html>
  <head>
    <title>Device Properties Example</title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.2.min.js"></script>
    <!---  VALOR APIKEY: AIzaSyCTj2UDMMYLM28CcqpQBGmycxMeUslXbRE --> 
    <!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTj2UDMMYLM28CcqpQBGmycxMeUslXbRE"></script>
    <script src="https://rawgit.com/HPNeo/gmaps/master/gmaps.js"></script>-->
  </head>
  <body style="position: relative; margin:0 auto; text-align: center; width: 100%; background-color:#B0A88B; ">
    <div id="cabecera">
        <div style="float: left; position: absolute; margin: 0 auto; margin-left:2em;" id="flechaBack"><img src="home.png" onclick="atras();"></div>
        <h1 id="tituloCabeceraPrincipal" style="color:#36c; letter-spacing: 0.15em;" >PRL</h1>
    </div>
    <div id="cuerpo">
        <p id="fichero"></p>
        <!--Pinta mapa:-->
        <div id="basic_map"></div>
        <!--Pinta botones eleccion tipo navegacion:-->
        <div id="onlineOffline">
            <input id="ofWork" type="button" name="Trabajar Offline" value="Trabajar Offline" onclick="modoNav('1');" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase; margin-bottom:1em;"><br/>
            <input id="onWork"  type="button" name="Trabajar Online" value="Trabajar Online" onclick="modoNav('2');" style=" position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--OFFLINE-->
        <div id="modoOffline" style="display:none;">
            <input id="revOffline" type="button" name="Nueva Revisi&oacute;n" value="Nueva Revisi&oacute;n" onclick="abreNuevoForm();" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; margin-bottom: 4em; overflow: hidden; text-decoration: none; text-transform: uppercase;"><br/>
            <span>OBRA EJEMPLO 1 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 2 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 3 . CERRADA</span><br/>
            <span>OBRA EJEMPLO 4 . CERRADA</span><br/>
        </div>        
        <div id="nuevoNombreForm" style="display:none;">
            <input type="text" value="" placeholder="Nombre Obra" id="obraName" style="margin: 0 auto;text-align: center; border-radius: 4px; border: 0; font-size: 1.5em;  overflow: hidden; text-decoration: none; margin-bottom:1em;"><br/>
            <input id="nuevRevOff" type="button" value="Crear Nueva Revision" name="Crear Nueva Revision" onclick="guardaFormTmp();" style="position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--ONLINE-->
        <div id="modoOnline" style="display:none;">
            <select id="seleccionObra" style="margin: 0 auto;text-align: center; border-radius: 4px; border: 0; font-size: 1.5em;  overflow: hidden; text-decoration: none; margin-bottom:1em; font-size:12pt;">
                <option value="0" selected>Seleccione una obra</option>
                <option value="1">Obra 1</option>
                <option value="2">Obra 2</option>
                <option value="3">Obra 3</option>
                <option value="4">Obra 4</option>
            </select><br/>
            <input id="revOnln" type="button" name="Nueva Revisi&oacute;n" value="Nueva Revisi&oacute;n" onclick="abreNuevoForm();" style="margin-top:1em; position:relative; margin:0 auto; text-align:center; background-color:transparent; border-radius: 4px; border:0; box-shadow: inset 0 0 0 2px #36c; color:#36c !important; font-size: 1em; font-weight: 600; letter-spacing: 0.15em; height: 3.5em; line-height: 3.45em; overflow: hidden; text-decoration: none; text-transform: uppercase;">
        </div>
        <!--Pinta Formulario a partir del xml:-->
        <div id="formularioXML" style="display:none;" ></div>
    </div>

    <div id="pie"></div>
    <!--Valores necesarios ocultos:-->    
    <input type="hidden" id="onlOffl" value="">
    <input type="hidden" id="zonaSel" value=""> 
    <input type="hidden" id="carpetaTmpName" value="">
    <input type="hidden" id="nombrOculto" value=""> 
  </body>
</html>

<!--Funciones necesarias:-->
<script type="text/javascript" charset="utf-8">
document.addEventListener("deviceready", onBodyLoad, false);

var db;
var shortName = 'prl';
var version = '1.0';
var displayName = 'dbPrl';
var maxSize = 65535;

// this is called when an error happens in a transaction
function errorHandler(transaction, error) {
   alert('Error: ' + error.message + ' code: ' + error.code);
}
// this is called when a successful transaction happens
function successCallBack() {
   alert("DEBUGGING: success");
   AddValueToDB();
}
function nullHandler(){};
// called when the application loads
function onBodyLoad(){
alert("DEBUGGING: we are in the onBodyLoad() function");
 if (!window.openDatabase) {
   alert('Databases are not supported in this browser.');
   return;
 }
    db = openDatabase(shortName, version, displayName,maxSize);
    db.transaction(function(tx){
        //tx.executeSql('DROP TABLE proyectos_app',[],nullHandler,errorHandler);
        tx.executeSql('CREATE TABLE IF NOT EXISTS proyectos_app (id unique, nombre, descripcion, version_form)',[],nullHandler,errorHandler);        
        tx.executeSql('CREATE TABLE IF NOT EXISTS formulario (id unique, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto)',[],nullHandler,errorHandler);
    },errorHandler,successCallBack);
}
function ListDBValues() {
    if (!window.openDatabase) {
        alert('Databases are not supported in this browser.');
    return;
    }
    db.transaction(function(transaction) {
        transaction.executeSql('SELECT * FROM proyectos_app;', [], function(transaction, result) {
            if (result != null && result.rows != null) {
                for (var i = 0; i < result.rows.length; i++) {
                    var row = result.rows.item(i);
                    alert('id->'+row.id+' version_form->'+row.version_form+' nombre-> '+row.nombre);
                    var versionMvl = row.id;
                    $.post( "http://www.alu-ftth.com/appPrl/dameFormActualizado.php", { proyecto:'1', zona:'0'})
                        .done(function( data ) {
                            alert('data del post->'+data);
                            data=2;
                            if(data!=versionMvl){
                                alert('dif versiones..compruebo si tengo la tabla y la borro y la creo entera de 0.');
                                actualizaDatosForm(versionMvl);
                            }else{
                             alert('misma version...acaba aqui, pinto form;');
                            }
                        });  
                }
            }
        },errorHandler);
    },errorHandler,nullHandler);
    return;
}

function listDBForm() {
    if (!window.openDatabase) {
        alert('Databases are not supported in this browser.');
    return;
    } 
    db.transaction(function(transaction) {
        transaction.executeSql('SELECT * FROM formulario;', [], function(transaction, result) {
            if (result != null && result.rows != null) {
                for (var i = 0; i < result.rows.length; i++) {
                    var row = result.rows.item(i);
                    alert('id->'+row.id+' pregunta->'+row.pregunta+' respuestas-> '+row.respuestas);
                }
            }
        },errorHandler);
    },errorHandler,nullHandler);
    return false;
}
function AddValueToDB() {
 if (!window.openDatabase) {
   alert('Databases are not supported in this browser.');
   return;
 }
    db.transaction(function(transaction) {
        transaction.executeSql("INSERT INTO proyectos_app (id, nombre, descripcion, version_form) VALUES (1,'appPRL','Aplicaci√≥n para el seguimiento de obras de PRL','1')",[],nullHandler,errorHandler);
        //transaction.executeSql('INSERT INTO User(FirstName, LastName) VALUES (?,?)',[$('#txFirstName').val(), $('#txLastName').val()],nullHandler,errorHandler);
    });
    ListDBValues();
    return false;
}
function actualizaDatosForm(versionMvl) {
 if (!window.openDatabase) {
   alert('Databases are not supported in this browser.');
   return;
 }
        $.post( "http://www.alu-ftth.com/appPrl/dameFormActualizado.php", { proyecto:'1', zona:'1'})
        .done(function( data ) {
            console.log(data);
            db.transaction(function(transaction) {
                var completas = data.split("},");
                var contador = completas.length
                alert('contador en post'+contador);
                //Borro la tabla y la creo vacia:
                transaction.executeSql('DROP TABLE formulario',[],nullHandler,errorHandler);
                transaction.executeSql('UPDATE proyectos_app SET version_form=? WHERE id=1',[versionMvl],nullHandler,errorHandler);
                transaction.executeSql('CREATE TABLE IF NOT EXISTS formulario (id unique, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto)',[],nullHandler,errorHandler);
                for (var i=0;i<contador;i++){
                    var parteCompleta = completas[i].split(',');
                    var ids = parteCompleta[0].split(':');
                    if(i==0){
                        var idLimpio = ids[0].replace('[{"id"', 'id');
                    }else{
                        var idLimpio = ids[0].replace('{"id"', 'id');
                    }              
                    var respId = ids[1].replace("\"", "");
                    var respId = respId.replace("\"", "");
                    //console.log('parte1->'+parteCompleta[1]);
                    var idsPregunta = parteCompleta[1].split(':');
                    var idPregLimpio = idsPregunta[0].replace('"id_pregunta"', 'id_pregunta');
                    var respIdPreg = idsPregunta[1].replace("\"", "");
                    var respIdPreg = respIdPreg.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[2]);
                    var preguntaCompleta = parteCompleta[2].split(':');
                    var prgLimpia = preguntaCompleta[0].replace('"pregunta"', 'pregunta');
                    var respPregnt = preguntaCompleta[1].replace("\"", "");
                    var respPregnt = respPregnt.replace("\"", "");
                    //console.log('parte3->'+parteCompleta[3]);
                    var respuestasCompleta = parteCompleta[3].split(':');
                    var rspLmpia = respuestasCompleta[0].replace('"respuestas"', 'respuestas');
                    var respPrgnCompe = respuestasCompleta[1].replace("\"", "");
                    var respPrgnCompe = respPrgnCompe.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[4]);
                    var catCompleta = parteCompleta[4].split(':');
                    var catLimpia = catCompleta[0].replace('"categoria"', 'categoria');
                    var catRspLmpia = catCompleta[1].replace("\"", "");
                    var catRspLmpia = catRspLmpia.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[2]);
                    var contCompleta = parteCompleta[5].split(':');
                    var cntLmpia = contCompleta[0].replace('"si_continua"', 'si_continua');
                    var contRsp = contCompleta[1].replace("\"", "");
                    var contRsp = contRsp.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[2]);
                    var noContCompleta = parteCompleta[6].split(':');
                    var noContLimpia = noContCompleta[0].replace('"no_continua"', 'no_continua');
                    var nocontResp = noContCompleta[1].replace("\"", "");
                    var nocontResp = nocontResp.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[2]);
                    var npContiComplta = parteCompleta[7].split(':');
                    var npCntniaLmpia = npContiComplta[0].replace('"np_continua"', 'np_continua');
                    var npContResp = npContiComplta[1].replace("\"", "");
                    var npContResp = npContResp.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[2]);
                    var accionCompleta = parteCompleta[8].split(':');
                    var accLimpia = accionCompleta[0].replace('"accion"', 'accion');
                    var accResp = accionCompleta[1].replace("\"", "");
                    var accResp = accResp.replace("\"", "");
                    //console.log('parte2->'+parteCompleta[2]);
                    var proyectoCompleto = parteCompleta[9].split(':');
                    var proyLimpio = proyectoCompleto[0].replace('"proyecto"', 'proyecto');
                    var proyecResp = proyectoCompleto[1].replace("\"", "");
                    var proyecResp = proyecResp.replace("\"", "");
        
                    transaction.executeSql('INSERT INTO formulario (id, id_pregunta, pregunta, respuestas, categoria, si_continua, no_continua, np_continua, accion, proyecto) VALUES (?,?,?,?,?,?,?,?,?,?)',[respId,respIdPreg, respPrgnCompe,rspLmpia,catRspLmpia,contRsp,nocontResp,npContResp,accResp,proyecResp],nullHandler,errorHandler);

                    //alert('-> '+idLimpio+' -> '+respId+'\n -> '+idPregLimpio+' -> '+respIdPreg+'\n -> '+prgLimpia+' -> '+respPregnt+'\n -> '+rspLmpia+' -> '+respPrgnCompe+'\n -> '+catLimpia+' -> '+catRspLmpia+'\n -> '+cntLmpia+' -> '+contRsp+'\n -> '+noContLimpia+' -> '+nocontResp+'\n -> '+npCntniaLmpia+' ->'+npContResp+'\n -> '+accLimpia+' ->'+accResp+'\n -> '+proyLimpio+' ->'+proyecResp);
                }

            },errorHandler,successCallBack);
            
    });

    listDBForm();
    return false;
}
</script>